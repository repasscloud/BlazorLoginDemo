@page "/platform/organizations/{Id}/edit2"
@using System.ComponentModel.DataAnnotations
@using BlazorLoginDemo.Shared.Models.Kernel.Platform
@using BlazorLoginDemo.Shared.Models.Static.Platform
@inject NavigationManager Nav

<EditForm Model="_org" OnValidSubmit="SaveAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="mb-0">Edit Organization</h2>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary" @onclick="Back">Cancel</button>
<button type="submit" class="btn btn-primary">
    @if (_isSaving)
    {
        <span class="spinner-border spinner-border-sm me-2"></span>
    }
    Save
</button>

        </div>
    </div>

    <!-- Identity -->
    <div class="card mb-3">
        <div class="card-header">Identity</div>
        <div class="card-body row g-3">
            <div class="col-md-6">
                <label class="form-label">Id</label>
                <InputText class="form-control" @bind-Value="_org.Id" readonly />
            </div>
            <div class="col-md-6">
                <label class="form-label">Name</label>
                <InputText class="form-control" @bind-Value="_org.Name" />
                <div class="form-text">Display name for the organization.</div>
            </div>

            <div class="col-md-6">
                <label class="form-label">Type</label>
                <InputSelect class="form-select" @bind-Value="_org.Type">
                    @foreach (var t in Enum.GetValues<OrganizationType>())
                    {
                        <option value="@t">@t</option>
                    }
                </InputSelect>
            </div>

            <div class="col-md-6">
                <label class="form-label">Is Active</label>
                <div class="form-check">
                    <InputCheckbox class="form-check-input" @bind-Value="_org.IsActive" />
                    <label class="form-check-label">Active</label>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label">Parent Organization Id</label>
                <InputText class="form-control" @bind-Value="_org.ParentOrganizationId" />
                <div class="form-text">Leave empty if this is a top-level organization.</div>
            </div>

            <div class="col-12">
                <label class="form-label">Parent (read-only)</label>
                <input class="form-control" value="@(_org.Parent?.Name ?? "(none)")" readonly />
                <div class="form-text">Reference only; resolve and assign via ParentOrganizationId.</div>
            </div>

            <div class="col-12">
                <label class="form-label">Children (read-only)</label>
                <ul class="list-group">
                    @if (_org.Children?.Any() == true)
                    {
                        @foreach (var c in _org.Children)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @(c.Name)
                                <span class="text-muted small">@(c.Id)</span>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">No child organizations.</li>
                    }
                </ul>
            </div>
        </div>
    </div>

    <!-- Company & Billing Defaults -->
    <div class="card mb-3">
        <div class="card-header">Company Defaults</div>
        <div class="card-body row g-3">
            <div class="col-md-3">
                <label class="form-label">Default Currency (ISO 4217)</label>
                <InputText class="form-control" @bind-Value="_org.DefaultCurrency" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Tax Id Type</label>
                <InputText class="form-control" @bind-Value="_org.TaxIdType" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Tax Id</label>
                <InputText class="form-control" @bind-Value="_org.TaxId" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Tax Last Validated</label>
                <InputDate class="form-control" @bind-Value="_org.TaxLastValidated" />
            </div>
        </div>
    </div>

    <!-- Physical Address -->
    <div class="card mb-3">
        <div class="card-header">Physical Address</div>
        <div class="card-body row g-3">
            <div class="col-md-4">
                <label class="form-label">Address Line 1</label>
                <InputText class="form-control" @bind-Value="_org.AddressLine1" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Address Line 2</label>
                <InputText class="form-control" @bind-Value="_org.AddressLine2" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Address Line 3</label>
                <InputText class="form-control" @bind-Value="_org.AddressLine3" />
            </div>
            <div class="col-md-3">
                <label class="form-label">City</label>
                <InputText class="form-control" @bind-Value="_org.City" />
            </div>
            <div class="col-md-3">
                <label class="form-label">State/Province</label>
                <InputText class="form-control" @bind-Value="_org.State" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Postal Code</label>
                <InputText class="form-control" @bind-Value="_org.PostalCode" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Country</label>
                <InputText class="form-control" @bind-Value="_org.Country" />
            </div>
        </div>
    </div>

    <!-- Mailing Address -->
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <span>Mailing Address</span>
            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CopyPhysicalToMailing">
                Copy from Physical
            </button>
        </div>
        <div class="card-body row g-3">
            <div class="col-md-4">
                <label class="form-label">Address Line 1</label>
                <InputText class="form-control" @bind-Value="_org.MailingAddressLine1" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Address Line 2</label>
                <InputText class="form-control" @bind-Value="_org.MailingAddressLine2" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Address Line 3</label>
                <InputText class="form-control" @bind-Value="_org.MailingAddressLine3" />
            </div>
            <div class="col-md-3">
                <label class="form-label">City</label>
                <InputText class="form-control" @bind-Value="_org.MailingCity" />
            </div>
            <div class="col-md-3">
                <label class="form-label">State/Province</label>
                <InputText class="form-control" @bind-Value="_org.MailingState" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Postal Code</label>
                <InputText class="form-control" @bind-Value="_org.MailingPostalCode" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Country</label>
                <InputText class="form-control" @bind-Value="_org.MailingCountry" />
            </div>
        </div>
    </div>

    <!-- Contacts -->
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">General / Commercial Contact</div>
                <div class="card-body row g-3">
                    <div class="col-md-6">
                        <label class="form-label">First Name</label>
                        <InputText class="form-control" @bind-Value="_org.ContactPersonFirstName" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Last Name</label>
                        <InputText class="form-control" @bind-Value="_org.ContactPersonLastName" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CC</label>
                        <InputText class="form-control" @bind-Value="_org.ContactPersonCountryCode" />
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Phone</label>
                        <InputText class="form-control" @bind-Value="_org.ContactPersonPhone" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="_org.ContactPersonEmail" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Job Title</label>
                        <InputText class="form-control" @bind-Value="_org.ContactPersonJobTitle" />
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">Billing Contact</div>
                <div class="card-body row g-3">
                    <div class="col-md-6">
                        <label class="form-label">First Name</label>
                        <InputText class="form-control" @bind-Value="_org.BillingPersonFirstName" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Last Name</label>
                        <InputText class="form-control" @bind-Value="_org.BillingPersonLastName" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CC</label>
                        <InputText class="form-control" @bind-Value="_org.BillingPersonCountryCode" />
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Phone</label>
                        <InputText class="form-control" @bind-Value="_org.BillingPersonPhone" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="_org.BillingPersonEmail" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Job Title</label>
                        <InputText class="form-control" @bind-Value="_org.BillingPersonJobTitle" />
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">Admin / Technical Contact</div>
                <div class="card-body row g-3">
                    <div class="col-md-6">
                        <label class="form-label">First Name</label>
                        <InputText class="form-control" @bind-Value="_org.AdminPersonFirstName" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Last Name</label>
                        <InputText class="form-control" @bind-Value="_org.AdminPersonLastName" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">CC</label>
                        <InputText class="form-control" @bind-Value="_org.AdminPersonCountryCode" />
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Phone</label>
                        <InputText class="form-control" @bind-Value="_org.AdminPersonPhone" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="_org.AdminPersonEmail" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Job Title</label>
                        <InputText class="form-control" @bind-Value="_org.AdminPersonJobTitle" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Domains -->
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <span>Domains</span>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => Nav.NavigateTo($"/platform/organizations/{_org.Id}/domains"))">
                    Manage Domains
                </button>
            </div>
        </div>
        <div class="card-body">
            <ul class="list-group">
                @if (_org.Domains?.Any() == true)
                {
                    @foreach (var d in _org.Domains)
                    {
                        <li class="list-group-item">@d</li>
                    }
                }
                else
                {
                    <li class="list-group-item text-muted">No domains configured.</li>
                }
            </ul>
            <div class="form-text mt-2">
                Domains are a collection object; editing handled on the dedicated page.
            </div>
        </div>
    </div>

    <!-- Policies -->
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <span>Policies</span>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => Nav.NavigateTo($"/platform/organizations/{_org.Id}/policies/travel"))">
                    Manage Travel Policies
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => Nav.NavigateTo($"/platform/organizations/{_org.Id}/policies/expense"))">
                    Manage Expense Policies
                </button>
            </div>
        </div>
        <div class="card-body row">
            <div class="col-md-6">
                <h6>Travel Policies</h6>
                <ul class="list-group">
                    @if (_org.TravelPolicies?.Any() == true)
                    {
                        @foreach (var p in _org.TravelPolicies)
                        {
                            <li class="list-group-item">@p</li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">None</li>
                    }
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Expense Policies</h6>
                <ul class="list-group">
                    @if (_org.ExpensePolicies?.Any() == true)
                    {
                        @foreach (var p in _org.ExpensePolicies)
                        {
                            <li class="list-group-item">@p</li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">None</li>
                    }
                </ul>
            </div>
        </div>
    </div>

    <!-- Licensing -->
    <div class="card mb-3">
        <div class="card-header">Billing / Licensing</div>
        <div class="card-body row g-3">
            <div class="col-md-6">
                <label class="form-label">License Agreement Id</label>
                <InputText class="form-control" @bind-Value="_org.LicenseAgreementId" />
            </div>
            <div class="col-md-6">
                <label class="form-label">License Agreement (read-only)</label>
                <input class="form-control" value="@(_org.LicenseAgreement is null ? "(none)" : "Loaded")" readonly />
            </div>
        </div>
    </div>

    <!-- Audit -->
    <div class="card mb-4">
        <div class="card-header">Audit</div>
        <div class="card-body row g-3">
            <div class="col-md-6">
                <label class="form-label">Last Updated (UTC)</label>
                <InputDate class="form-control" @bind-Value="_org.LastUpdatedUtc" />
                <div class="form-text">Auto-updated on save.</div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    [Parameter] public string? Id { get; set; }

    private OrganizationUnified _org = new OrganizationUnified
    {
        Name = string.Empty
    };
    private bool _isSaving;

    protected override Task OnInitializedAsync()
    {
        // TODO: replace with actual load via your admin service
        if (!string.IsNullOrWhiteSpace(Id))
        {
            // placeholder: Id present => keep generated Id but set it so you can see it
            _org.Id = Id!;
        }
        return Task.CompletedTask;
    }

    private async Task SaveAsync()
    {
        _isSaving = true;
        try
        {
            _org.LastUpdatedUtc = DateTime.UtcNow;
            // TODO: call your admin org service to persist _org
            await Task.Delay(150); // placeholder
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void Back() => Nav.NavigateTo("/platform/organizations");

    private void CopyPhysicalToMailing()
    {
        _org.MailingAddressLine1 = _org.AddressLine1;
        _org.MailingAddressLine2 = _org.AddressLine2;
        _org.MailingAddressLine3 = _org.AddressLine3;
        _org.MailingCity       = _org.City;
        _org.MailingState      = _org.State;
        _org.MailingPostalCode = _org.PostalCode;
        _org.MailingCountry    = _org.Country;
    }
}
