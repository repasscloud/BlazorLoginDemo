@page "/admin/avausers/{AvaUserId?}/usersyspreference"
@rendermode InteractiveServer

@* KEEP YOUR EXISTING @page LINE ABOVE. DO NOT CHANGE YOUR ROUTE. *@
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using BlazorLoginDemo.Shared.Models.Kernel.User
@using BlazorLoginDemo.Shared.Models.Static

@inject BlazorLoginDemo.Shared.Services.Interfaces.User.IAvaUserSysPreferenceService AvaUserSysPreferenceService
@inject BlazorLoginDemo.Shared.Services.Interfaces.User.IAvaUserService AvaUserService
@inject BlazorLoginDemo.Shared.Services.Interfaces.Policy.ITravelPolicyService TravelPolicyService
@inject NavigationManager Nav

<PageTitle>User Preference</PageTitle>

<EditForm Model="_model" OnValidSubmit="SaveAsync">
    <DataAnnotationsValidator />
    <ValidationSummary class="mb-3" />

    <!-- Header / action bar (visual tidy-up; no route changes, no logging) -->
    <div class="card shadow-sm mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-person-gear"></i>
                <strong>User System Preference</strong>
                @if (!string.IsNullOrWhiteSpace(_model.Email))
                {
                    <span class="badge bg-light text-dark border">@_model.Email</span>
                }
                @if (!string.IsNullOrWhiteSpace(_model.Id))
                {
                    <span class="badge bg-secondary">Id: @_model.Id</span>
                }
                <span class="badge @(_model.IsActive ? "bg-success" : "bg-danger")">
                    @(_model.IsActive ? "Active" : "Inactive")
                </span>
            </div>

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="Back">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                @if (!_isNew)
                {
                    <button type="button" class="btn btn-outline-danger btn-sm" disabled="_busy" @onclick="DeleteAsync">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                }
                <button type="submit" class="btn btn-primary btn-sm" disabled="_busy">
                    <i class="bi bi-save"></i> @(_isNew ? "Create" : "Save")
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="card-body">
            <!-- Identity / linkage -->
            <div class="row g-3">
                <div class="col-12 col-lg-6">
                    <label class="form-label">ASP.NET User Id</label>
                    <InputText class="form-control" @bind-Value="_model.AspNetUsersId" />
                </div>
                <div class="col-12 col-lg-3">
                    <label class="form-label">Ava User Id</label>
                    <InputText class="form-control" @bind-Value="_model.AvaUserId" />
                </div>
                <div class="col-12 col-lg-3 d-flex align-items-center">
                    <div class="form-check mt-4">
                        <InputCheckbox class="form-check-input" @bind-Value="_model.IsActive" />
                        <label class="form-check-label">Active</label>
                    </div>
                </div>

                <div class="col-12 col-lg-6">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="_model.Email" />
                </div>
            </div>

            <hr class="my-4" />

            <!-- Personal / Passport -->
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label">First name</label>
                    <InputText class="form-control" @bind-Value="_model.FirstName" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Middle name</label>
                    <InputText class="form-control" @bind-Value="_model.MiddleName" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Last name</label>
                    <InputText class="form-control" @bind-Value="_model.LastName" />
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">Date of birth</label>
                    <InputDate class="form-control" @bind-Value="_model.DateOfBirth" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Gender</label>
                    <InputSelect class="form-select" @bind-Value="_model.Gender">
                        @foreach (var g in Enum.GetValues<GenderType>())
                        {
                            <option value="@g">@g</option>
                        }
                    </InputSelect>
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">Country of issue</label>
                    <InputSelect class="form-select" @bind-Value="_model.CountryOfIssue">
                        @foreach (var c in Enum.GetValues<PassportCountry>())
                        {
                            <option value="@c">@c</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Passport expiry</label>
                    <InputDate class="form-control" @bind-Value="_model.PassportExpirationDate" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Home airport (IATA)</label>
                    <InputText class="form-control text-uppercase" @bind-Value="_model.OriginLocationCode" @oninput="UppercaseIata" />
                </div>
            </div>

            <hr class="my-4" />

            <!-- Flight prefs -->
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label">Default cabin</label>
                    <InputSelect class="form-select" @bind-Value="_model.DefaultFlightSeating">
                        @foreach (var c in _cabins)
                        {
                            <option value="@c">@c</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Max cabin</label>
                    <InputSelect class="form-select" @bind-Value="_model.MaxFlightSeating">
                        @foreach (var c in _cabins)
                        {
                            <option value="@c">@c</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Cabin coverage</label>
                    <InputSelect class="form-select" @bind-Value="_model.CabinClassCoverage">
                        @foreach (var cv in _coverage)
                        {
                            <option value="@cv">@cv</option>
                        }
                    </InputSelect>
                </div>

                <!-- Airline codes (CSV <-> string[]) -->
                <div class="col-12 col-lg-6">
                    <label class="form-label">Include airline codes (CSV)</label>
                    <InputTextArea class="form-control" @bind-Value="IncludedCsv" rows="2" />
                    <div class="form-text">Example: QF,AA,BA</div>
                </div>

                <div class="col-12 col-lg-6">
                    <label class="form-label">Exclude airline codes (CSV)</label>
                    <InputTextArea class="form-control" @bind-Value="ExcludedCsv" rows="2" />
                    <div class="form-text">Example: JQ,FR</div>
                </div>

                <div class="col-12 col-md-3">
                    <div class="form-check mt-2">
                        <InputCheckbox class="form-check-input" @bind-Value="_model.NonStopFlight" />
                        <label class="form-check-label">Non-stop only</label>
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            <!-- Money / limits -->
            <div class="row g-3">
                <div class="col-12 col-md-3">
                    <label class="form-label">Currency (ISO 4217)</label>
                    <InputText class="form-control text-uppercase" @bind-Value="_model.DefaultCurrencyCode" @oninput="UppercaseCurrency" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Max flight price</label>
                    <InputNumber class="form-control" @bind-Value="_model.MaxFlightPrice" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Search max results</label>
                    <InputNumber class="form-control" @bind-Value="_model.MaxResults" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Days in advance (default)</label>
                    <InputNumber class="form-control" @bind-Value="_model.DefaultCalendarDaysInAdvanceForFlightBooking" />
                </div>

                <div class="col-12 col-md-3">
                    <label class="form-label">Bookable from (hh:mm:ss)</label>
                    <InputText class="form-control" @bind-Value="_model.FlightBookingTimeAvailableFrom" placeholder="07:00:00" />
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Bookable to (hh:mm:ss)</label>
                    <InputText class="form-control" @bind-Value="_model.FlightBookingTimeAvailableTo" placeholder="22:00:00" />
                </div>
                <div class="col-12 col-md-3">
                    <div class="form-check mt-2">
                        <InputCheckbox class="form-check-input" @bind-Value="_model.EnableSaturdayFlightBookings" />
                        <label class="form-check-label">Allow Saturday bookings</label>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="form-check mt-2">
                        <InputCheckbox class="form-check-input" @bind-Value="_model.EnableSundayFlightBookings" />
                        <label class="form-check-label">Allow Sunday bookings</label>
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            <!-- Policy / Client refs -->
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label">Travel policy name</label>
                    <InputText class="form-control" @bind-Value="_model.TravelPolicyName" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Travel policy Id</label>
                    <InputText class="form-control" @bind-Value="_model.TravelPolicyId" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Expense policy Id</label>
                    <InputText class="form-control" @bind-Value="_model.ExpensePolicyId" />
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">AvaClient Id</label>
                    <InputText class="form-control" @bind-Value="_model.AvaClientId" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Client Id (external)</label>
                    <InputText class="form-control" @bind-Value="_model.ClientId" />
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="card-footer small text-muted d-flex justify-content-between align-items-center">
            <div>
                <span class="me-3">Status: @_status</span>
                <span>Last saved: @_lastSaved</span>
            </div>
            <div class="text-truncate">
                <span class="text-muted">@Nav.Uri</span>
            </div>
        </div>
    </div>
</EditForm>

@code {
    [Parameter] public string? AvaUserId { get; set; }

    private AvaUserSysPreference _model = new AvaUserSysPreference
    {
        AspNetUsersId = string.Empty,
        Email = "test@test.com",
        FirstName = string.Empty,
        LastName = string.Empty,
        DateOfBirth = new DateOnly(1900, 1, 1),
        PassportName = string.Empty,
        Gender = BlazorLoginDemo.Shared.Models.Static.GenderType.Unspecified,
        CountryOfIssue = BlazorLoginDemo.Shared.Models.Static.PassportCountry.AUS,
        PassportExpirationDate = new DateOnly(1900, 1, 1),
        DefaultFlightSeating = "ECONOMY",
        MaxFlightSeating = "ECONOMY",
        CabinClassCoverage = "MOST_SEGMENTS",
        DefaultCurrencyCode = "AUD",
        AvaUserId = string.Empty
    };
    private bool _isNew;
    private bool _busy;
    private string _status = "Ready";
    private string _lastSaved = "—";

    private readonly string[] _cabins = new[] { "ECONOMY", "PREMIUM_ECONOMY", "BUSINESS", "FIRST" };
    private readonly string[] _coverage = new[] { "MOST_SEGMENTS", "ALL_SEGMENTS" };

    // CSV wrappers <-> string[] on the model
    private string IncludedCsv
    {
        get => string.Join(",", _model.IncludedAirlineCodes ?? Array.Empty<string>());
        set => _model.IncludedAirlineCodes = ParseCsv(value);
    }
    private string ExcludedCsv
    {
        get => string.Join(",", _model.ExcludedAirlineCodes ?? Array.Empty<string>());
        set => _model.ExcludedAirlineCodes = ParseCsv(value);
    }
    private static string[] ParseCsv(string? s) =>
        string.IsNullOrWhiteSpace(s)
            ? Array.Empty<string>()
            : s.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
               .Select(x => x.ToUpperInvariant())
               .Distinct()
               .ToArray();

    // EXACT LOAD FLOW YOU SPECIFIED
    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(AvaUserId))
        {
            var found = await AvaUserSysPreferenceService.GetByUserIdAsync(AvaUserId);
            if (found is not null)
            {
                _model = found;
                _isNew = false;
                return;
            }
            else
            {
                // get the data from the user account
                var usr = await AvaUserService.GetByIdAsync(AvaUserId);
                if (usr is null)
                {
                    Nav.NavigateTo("/");
                    return;
                }

                if (usr.TravelPolicyId is null)
                {
                    Nav.NavigateTo("/");
                    return;
                }

                var travelPolicy = await TravelPolicyService.GetByIdAsync(usr.TravelPolicyId);
                if (travelPolicy is null)
                {
                    Nav.NavigateTo("/");
                    return;
                }

                _model.AvaUserId = AvaUserId;
                _model.AspNetUsersId = usr.AspNetUsersId;
                _model.IsActive = usr.IsActive;
                _model.Email = usr.Email;
                _model.TravelPolicyId = usr.TravelPolicyId;
                _model.ExpensePolicyId = string.Empty;
                _model.OriginLocationCode = usr.OriginLocationCode;
                _model.DefaultFlightSeating = travelPolicy.DefaultFlightSeating ?? "ECONOMY";
                _model.MaxFlightSeating = travelPolicy.MaxFlightSeating ?? "ECONOMY";
                _model.IncludedAirlineCodes = travelPolicy.IncludedAirlineCodes ?? Array.Empty<string>();
                _model.ExcludedAirlineCodes = travelPolicy.ExcludedAirlineCodes ?? Array.Empty<string>();
                _model.CabinClassCoverage = travelPolicy.CabinClassCoverage ?? "MOST_SEGMENTS";
                _model.NonStopFlight = travelPolicy.NonStopFlight;
                _model.DefaultCurrencyCode = travelPolicy.DefaultCurrencyCode;
                _model.MaxFlightPrice = travelPolicy.MaxFlightPrice;
                _model.MaxResults = 20;
                _model.FlightBookingTimeAvailableFrom = travelPolicy.FlightBookingTimeAvailableFrom;
                _model.FlightBookingTimeAvailableTo = travelPolicy.FlightBookingTimeAvailableTo;
                _model.EnableSaturdayFlightBookings = travelPolicy.EnableSaturdayFlightBookings;
                _model.EnableSundayFlightBookings = travelPolicy.EnableSundayFlightBookings;
                _model.DefaultCalendarDaysInAdvanceForFlightBooking = travelPolicy.DefaultCalendarDaysInAdvanceForFlightBooking;
                _model.AvaClientId = usr.AvaClientId;
                _model.ClientId = string.Empty;

                _isNew = true;
            }
        }
        else
        {
            // cannot load page if the value is not provided, send them back to home page - rewrite this later as an error
            // TODO: create error page here
            Nav.NavigateTo("/");
            return;
        }
    }

    private async Task SaveAsync()
    {
        _busy = true; _status = "Saving…";
        try
        {
            if (_isNew)
                _model = await AvaUserSysPreferenceService.CreateAsync(_model);
            else
                _model = await AvaUserSysPreferenceService.UpdateAsync(_model);

            _isNew = false;
            _status = "Saved";
            _lastSaved = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
        }
        catch
        {
            _status = "Save failed";
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task DeleteAsync()
    {
        if (_isNew) return;
        _busy = true; _status = "Deleting…";
        try
        {
            var ok = await AvaUserSysPreferenceService.DeleteAsync(_model.Id);
            _status = ok ? "Deleted" : "Not found";
            Back();
        }
        finally
        {
            _busy = false;
        }
    }

    private void Back() => Nav.NavigateTo("/");

    private void UppercaseIata(ChangeEventArgs _)
    {
        if (!string.IsNullOrEmpty(_model.OriginLocationCode))
            _model.OriginLocationCode = _model.OriginLocationCode.ToUpperInvariant();
    }
    private void UppercaseCurrency(ChangeEventArgs _)
    {
        if (!string.IsNullOrEmpty(_model.DefaultCurrencyCode))
            _model.DefaultCurrencyCode = _model.DefaultCurrencyCode.ToUpperInvariant();
    }
}
