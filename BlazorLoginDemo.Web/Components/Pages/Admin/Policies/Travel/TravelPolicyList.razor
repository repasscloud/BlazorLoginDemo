@page "/admin/policies/travel/{AvaClientId}/list"
@rendermode InteractiveServer

@using BlazorLoginDemo.Shared.Models.Kernel.Client;
@using Microsoft.AspNetCore.Components.Forms

@inject BlazorLoginDemo.Shared.Services.Interfaces.Policy.ITravelPolicyService TravelPolicyService
@inject BlazorLoginDemo.Shared.Services.Interfaces.Client.IAvaClientService AvaClientService
@inject NavigationManager Nav

<PageTitle>[ADMIN] Policy List</PageTitle>

<div class="container py-4">

    <h3 class="mb-3">Travel Policy List</h3>
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-end">
            <a class="btn btn-sm btn-outline-primary"
                href="@($"/admin/policies/travel/{AvaClientId}/new/additional")">
                <i class="bi bi-file-earmark-plus"></i> New Policy
            </a>
        </div>
        <div class="card-body">

            @if (_busy)
            {
                <div class="d-flex align-items-center justify-content-center" style="min-height:30vh;">
                    <div class="text-center">
                        <div class="spinner-border" role="status" aria-hidden="true"></div>
                        <div class="mt-3">Searching…</div>
                    </div>
                </div>
            }
            else if (_searched && _results.Count == 0)
            {
                <div class="alert alert-warning mt-3">No travel policies matched "<strong>@AvaClientId</strong>".</div>
            }
            else if (_results.Count > 0)
            {
                @* Results Table *@
                <div class="table-responsive mt-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width:20%">Travel Policy ID</th>
                                <th style="width:50%">Policy Name</th>
                                <th style="width:10%">Default</th>
                                <th style="width:10%"></th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var x in _results.Skip(_resultsPage * PageSize).Take(PageSize))
                        {
                            <tr>
                                <td>@x.Id</td>
                                <td>@x.PolicyName</td>

                                <td>
                                    @if (x.IsDefault)
                                    { <i class="bi bi-bookmark-check text-success"></i> }
                                    else
                                    { <i class="bi bi-x-lg text-warning"></i> }
                                </td>

                                <td>
                                    <a class="btn btn-sm btn-outline-primary"
                                        href="@($"/admin/policies/travel/{x.Id}?returnPath=/admin/policies/travel/{AvaClientId}/list")">
                                        <i class="bi bi-search"></i> View/Edit
                                    </a>
                                </td>

                                <td>
                                    @if (!x.IsDefault)
                                    {
                                        <button class="btn btn-sm btn-outline-primary"
                                                @onclick="() => SetDefaultTravelPolicyAsync(x.Id, AvaClientId)">
                                            <i class="bi bi-award"></i> Set Default
                                        </button>
                                    }
                                </td>

                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">Showing @StartIndexDisplay–@EndIndexDisplay of @_results.Count results.</div>
                    <div class="btn-group">
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                @onclick="PrevPageAsync"
                                disabled="@(!CanGoPrev)">
                            ◀ Prev
                        </button>

                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                @onclick="NextPageAsync"
                                disabled="@(!CanGoNext)">
                            Next ▶
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string AvaClientId { get; set; } = string.Empty;

    private bool _busy = true;
    private bool _searched = false;

    private List<TravelPolicyListResult> _results = new(); // init so .Clear() is safe
    private int _resultsPage = 0;                       // 0-based

    private const int PageSize = 20;
    private int TotalPages => _results.Count == 0 ? 1 : (_results.Count + PageSize - 1) / PageSize;
    private int StartIndexDisplay => _results.Count == 0 ? 0 : (_resultsPage * PageSize) + 1;
    private int EndIndexDisplay => _results.Count == 0 ? 0 : Math.Min((_resultsPage * PageSize) + PageSize, _results.Count);
    

    private class TravelPolicyListResult
    {
        public string Id { get; set; } = default!;
        public string PolicyName { get; set; } = default!;
        public bool IsDefault { get; set; } = false;
    }

    // Enable/disable logic
    private bool CanGoPrev => _resultsPage > 0 && !_busy;
    private bool CanGoNext => _results.Count > (_resultsPage + 1) * PageSize && !_busy;

    private async Task PrevPageAsync()
    {
        if (_resultsPage > 0) _resultsPage--;
        await InvokeAsync(StateHasChanged);
    }

    private async Task NextPageAsync()
    {
        if ((_resultsPage + 1) * PageSize < _results.Count) _resultsPage++;
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnParametersSetAsync()
    {
        _busy = true;

        try
        {
            _results.Clear();

            if (!string.IsNullOrWhiteSpace(AvaClientId))
            {
                var _foundTravelPolicies = await TravelPolicyService.GetForClientAsync(AvaClientId);

                if (_foundTravelPolicies is null)
                {
                    _searched = true;  // no results, but still searched, display no results message
                    return;
                }

                _results = await PopulateClientResultsAsync(_foundTravelPolicies);
            }
            else
            {
                Nav.NavigateTo("/admin/policies/search");
                return;
            }
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }


    private async Task<List<TravelPolicyListResult>> PopulateClientResultsAsync(IReadOnlyList<TravelPolicy>? policies)
    {
        if (policies is null || policies.Count == 0)
            return [];

        // Fetch once (could be string or string?)
        var defaultId = await AvaClientService.GetDefaultTravelPolicyIdAsync(AvaClientId).ConfigureAwait(false);
        var hasDefault = !string.IsNullOrWhiteSpace(defaultId);

        var results = new List<TravelPolicyListResult>(policies.Count);

        for (int i = 0; i < policies.Count; i++)
        {
            var p = policies[i];
            results.Add(new TravelPolicyListResult
            {
                Id = p.Id,
                PolicyName = p.PolicyName,
                IsDefault = hasDefault && p.Id == defaultId
            });
        }

        return results;
    }

    private async Task SetDefaultTravelPolicyAsync(string policyId, string avaClientId)
    {
        var result = await TravelPolicyService.SetAsDefaultAsync(policyId, avaClientId);
        if (result)
        {
            Nav.NavigateTo(Nav.Uri, forceLoad: true);
        }
    }
}