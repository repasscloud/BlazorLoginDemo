@page "/platform/pnr/create/flight/results/{TravelQuoteId?}"
@rendermode InteractiveServer

@using System.Linq
@using Cinturon360.Shared.Models.Static.SysVar
@using Cinturon360.Shared.Services.Interfaces.Kernel
@using Cinturon360.Shared.Models.Kernel.Travel

@inject NavigationManager Nav
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerService _log

@if (_pageIsLoading == true)
{
    <div class="loading-overlay" role="status" aria-live="polite" aria-label="Loading">
        <div class="sky">
            <img src="/media/clouds-white.svg" class="cloud-img cloud-back c1" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-back c2" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-back c3" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-back c4" alt="" aria-hidden="true" />

            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c1" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c2" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c3" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c4" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c5" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c6" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c7" alt="" aria-hidden="true" />
            <img src="/media/clouds-white.svg" class="cloud-img cloud-front c8" alt="" aria-hidden="true" />

            <div class="loading-text">LOADING...</div>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(_error))
{
    <div class="container-fluid py-4 py-md-5">
        <div class="d-flex flex-column align-items-center justify-content-center text-center min-vh-50">
            <i class="bi bi-exclamation-triangle fs-1 text-danger mb-3" aria-hidden="true"></i>
            <h1 class="h4 mb-2">Error loading flight results</h1>
            <p class="text-muted mb-4">@_error</p>
            <div>
                <button class="btn btn-primary" @onclick="BackToSearch">
                    <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>
                    Back to search
                </button>
            </div>
        </div>
    </div>
}
else if (!hasFlightResults)
{
    <div class="container-fluid py-4 py-md-5">
          <div class="d-flex flex-column align-items-center justify-content-center text-center min-vh-50">
            <i class="bi bi-search fs-1 text-primary mb-3" aria-hidden="true"></i>
            <h1 class="h4 mb-2">No flights found</h1>
            <p class="text-muted">Try adjusting filters or run the search again.</p>
            <div class="mt-3">
                <button class="btn btn-primary" @onclick="BackToSearch">
                    <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>
                    Back to search
                </button>
            </div>
          </div>
    </div>
}
else
{
    <div class="container-fluid py-3 py-md-4">

        <!-- header -->
        <div class="row align-items-center g-2 mb-3">
            <div class="col">
                <h1 class="h4 m-0 d-flex align-items-center gap-2">
                    <i class="bi bi-airplane-engines" aria-hidden="true"></i>
                    Flight results
                </h1>
            </div>
            <div class="col d-flex justify-content-end align-items-center gap-2">
                <div class="text-muted small">
                    @((Result?.Options?.Count ?? 0)) options
                    @if (Result?.MoreResultsAvailable == true)
                    {
                        <span class="ms-2 badge bg-warning text-dark">More available</span>
                    }
                </div>
                <button class="btn btn-outline-secondary btn-sm" @onclick="ResetFilters">
                    <i class="bi bi-arrow-counterclockwise me-1" aria-hidden="true"></i>
                    Reset
                </button>
            </div>
        </div>

        <!-- filters -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-12 col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-search" aria-hidden="true"></i></span>
                            <input class="form-control" placeholder="Search carriers, flight #, airportsâ€¦" @bind="qText" />
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        @* <select class="form-select form-select-sm" @bind="qCabin">
                            <option value="">Any cabin</option>
                            @foreach (var c in AllCabins)
                            {
                                <option value="@c">@c</option>
                            }
                        </select> *@
                    </div>
                    <div class="col-6 col-md-2">
                        <select class="form-select form-select-sm" @bind="qDepartBucket">
                            <option value="">Any depart time</option>
                            <option value="overnight">Overnight</option>
                            <option value="morning">Morning</option>
                            <option value="afternoon">Afternoon</option>
                            <option value="evening">Evening</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2 d-flex align-items-center gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="nonstop" @bind="qNonstopOnly">
                            <label class="form-check-label" for="nonstop">Non-stop only</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="onestop" @bind="qAtMostOneStop">
                            <label class="form-check-label" for="onestop">â‰¤ 1 stop</label>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">@((Result?.Options?.FirstOrDefault()?.CurrencySymbol) ?? "$")</span>
                            <input class="form-control" type="number" placeholder="Min" @bind="qMinPrice" />
                            <input class="form-control" type="number" placeholder="Max" @bind="qMaxPrice" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- table -->
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead>
                    <tr>
                        <th>Carrier</th>
                        <th>Route</th>
                        <th class="text-center">Stops</th>
                        <th>Depart</th>
                        <th>Arrive</th>
                        <th>Duration</th>
                        <th>Cabins</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Select</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (FlightViewOption opt in Filtered)
                    {
                        <tr class="flight-row" @key="opt.Id" @onclick="@(()=>Toggle(opt))">
                            <td>
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (Carrier c in opt.DisplayCarriers)
                                    {
                                        @* <span class="badge bg-light text-dark" title="@c.Name">@c.Code</span> *@
                                        <img class="logo" src="@c.LogoUrl" alt="@c.Name" />
                                    }
                                </div>
                            </td>
                            <td>
                                <div class="fw-semibold">
                                    @opt.Origin <span class="text-muted">â†’</span> @opt.Destination
                                </div>
                            </td>
                            <td class="text-center">
                                @(opt.Stops == 0 ? "Non-stop" : opt.Stops == 1 ? "1 stop" : $"{opt.Stops} stops")
                            </td>
                            <td>@opt.DepartTime.ToLocalTime().ToString("HH:mm")</td>
                            <td>@opt.ArriveTime.ToLocalTime().ToString("HH:mm")</td>
                            <td>@opt.TotalDurationText</td>
                            <td>
                                @if (opt.Cabins?.Count > 0)
                                {
                                    @foreach (var cabinLabel in opt.Cabins)
                                    {
                                        var emoji = cabinLabel switch { "Economy" => "ðŸ’º", "Premium Economy" => "ðŸª‘", "Business" => "ðŸ›«", "First" => "â­", _ => "" };
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis me-1">
                                            @if (!string.IsNullOrEmpty(emoji)) { <span class="me-1">@emoji</span> }
                                            @cabinLabel
                                        </span>
                                    }
                                }
                            </td>
                            <td class="text-end"><span class="amount">@($"{opt.CurrencySymbol}{opt.Price:0}")</span> <span class="subtle">@opt.Currency</span></td>
                            <td class="text-end">
                                <button class="btn btn-primary @(Selected.Contains(opt.Id) ? "btn-success" : "btn-primary")"
                                        @onclick="(e)=>Select(opt)" @onclick:stopPropagation="true">
                                    @(Selected.Contains(opt.Id) ? "Selected" : "Select")
                                </button>
                            </td>
                        </tr>

                        <!-- details row -->
                        @if (opt.IsOpen)
                        {
                            <tr class="details-row">
                                <td colspan="9">
                                    <div class="card card-body">
                                        <!-- inclusion badges -->
                                        @if (opt.InclusionBadges.Any())
                                        {
                                            <div class="mb-2 d-flex flex-wrap gap-2">
                                                @foreach (var inc in opt.InclusionBadges)
                                                {
                                                    <span class="badge @inc.BadgeClass">
                                                        <i class="@inc.Icon" aria-hidden="true"></i>
                                                        <span class="ms-1">@inc.Label</span>
                                                    </span>
                                                }
                                            </div>
                                        }

                                        <!-- legs -->
                                        <div class="table-responsive">
                                            <table class="table table-sm small">
                                                <thead>
                                                    <tr>
                                                        <th>Carrier</th>
                                                        <th>Flight</th>
                                                        <th>From</th>
                                                        <th>To</th>
                                                        <th>Depart</th>
                                                        <th>Arrive</th>
                                                        <th>Duration</th>
                                                        <th>Cabin</th>
                                                        <th>Amenities</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                @for (var i = 0; i < opt.Legs.Count; i++)
                                                {
                                                    var leg = opt.Legs[i];
                                                    <tr @key="@($"{opt.Id}-{i}")">
                                                        <td>@leg.Carrier.Code</td>
                                                        <td>@leg.FlightNumber</td>
                                                        <td>@leg.Origin</td>
                                                        <td>@leg.Destination</td>
                                                        <td>@leg.Depart.ToLocalTime().ToString("dd MMM HH:mm")</td>
                                                        <td>@leg.Arrive.ToLocalTime().ToString("dd MMM HH:mm")</td>
                                                        <td>@leg.DurationText</td>
                                                        <td>@leg.CabinClass</td>
                                                        <td>
                                                            @if (leg.AmenityLabels.Any())
                                                            {
                                                                <div class="d-flex flex-wrap gap-1">
                                                                    @foreach (var label in leg.AmenityLabels)
                                                                    {
                                                                        <span class="badge bg-light text-dark">@label</span>
                                                                    }
                                                                </div>
                                                            }
                                                        </td>
                                                    </tr>
                                                    @if (leg.Layover is not null)
                                                    {
                                                        <tr class="table-light">
                                                            <td colspan="9" class="text-muted">
                                                                Layover @leg.Layover.Airport â€¢ @leg.Layover.DurationText
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- policies -->
                                        <div class="row g-2 small">
                                            @if (!string.IsNullOrWhiteSpace(opt.BaggageText))
                                            {
                                                <div class="col-12 col-md-3">
                                                    <div><span class="text-muted">Baggage:</span> @opt.BaggageText</div>
                                                </div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(opt.SeatPolicy))
                                            {
                                                <div class="col-12 col-md-3">
                                                    <div><span class="text-muted">Seating:</span> @opt.SeatPolicy</div>
                                                </div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(opt.ChangePolicy))
                                            {
                                                <div class="col-12 col-md-3">
                                                    <div><span class="text-muted">Changes:</span> @opt.ChangePolicy</div>
                                                </div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(opt.RefundPolicy))
                                            {
                                                <div class="col-12 col-md-3">
                                                    <div><span class="text-muted">Refunds:</span> @opt.RefundPolicy</div>
                                                </div>
                                            }
                                        </div>

                                        <!-- actions -->
                                        <div class="mt-3">
                                            <button class="btn btn-outline-secondary btn-sm" @onclick="(e)=>ShowCompare()" @onclick:stopPropagation="true">
                                                Compare JSON
                                            </button>
                                        </div>

                                        @if (ShowCompareJson)
                                        {
                                            <pre class="mt-2 small bg-dark text-light p-2 rounded" style="white-space:pre-wrap">@SelectedJson</pre>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    // ===== Parameters =====
    [Parameter] public string? TravelQuoteId { get; set; }

    // Also allow query-string usage if preferred later.
    [SupplyParameterFromQuery] public string? tq { get; set; }


    // ===== Http Client =====
    private HttpClient _client = default!;

    // ===== Page State =====
    private string? _error;
    bool? _pageIsLoading = true;
    private CancellationTokenSource? _cts;

    // ===== Data =====
    FlightSearchResponse? Result = null;

    // Query state
    string? qText = "";
    string? qCabin = "";
    bool qNonstopOnly = false;
    bool qAtMostOneStop = false;
    int? qMinPrice = null;
    int? qMaxPrice = null;
    string? qDepartBucket = "";

    AmenityQuery qAmenities = new AmenityQuery();

    // Selection
    HashSet<string> Selected = new HashSet<string>();

    bool ShowCompareJson = false;
    private string SelectedJson = string.Empty;

    private bool hasFlightResults => (Result?.Options?.Count ?? 0) > 0;

    IEnumerable<FlightViewOption> Filtered => (Result?.Options ?? Enumerable.Empty<FlightViewOption>()).Where(Matches);

    bool Matches(FlightViewOption o)
    {
        if (!string.IsNullOrEmpty(qText))
        {
            var s = o.SearchText ?? "";
            if (!s.Contains(qText, StringComparison.OrdinalIgnoreCase)) return false;
        }
        if (!string.IsNullOrEmpty(qCabin) && !(o.Cabins?.Contains(qCabin) ?? false)) return false;
        if (qNonstopOnly && o.Stops != 0) return false;
        if (qAtMostOneStop && o.Stops > 1) return false;

        if (qMinPrice.HasValue && o.Price < qMinPrice.Value) return false;
        if (qMaxPrice.HasValue && o.Price > qMaxPrice.Value) return false;

        if (!string.IsNullOrEmpty(qDepartBucket))
        {
            string? bucket = DepartBucket(o.DepartTime);
            if (!string.Equals(bucket, qDepartBucket, StringComparison.OrdinalIgnoreCase)) return false;
        }

        // amenities AND filter
        @* if (qAmenities.Wifi == true && !o.Amenities.Any(a => a.Name.Contains("wifi", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("wifi", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.Power == true && !o.Amenities.Any(a => a.Name.Contains("power", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("bolt", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.Usb == true && !o.Amenities.Any(a => a.Name.Contains("usb", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("usb", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.Ife == true && !o.Amenities.Any(a => a.Name.Contains("entertain", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("tv", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.Meal == true && !o.Amenities.Any(a => a.Name.Contains("meal", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("cup", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.LieFlat == true && !o.Amenities.Any(a => a.Name.Contains("lie-flat", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("moon", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.ExtraLegroom == true && !o.Amenities.Any(a => a.Name.Contains("legroom", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("arrows-expand", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.Lounge == true && !o.Amenities.Any(a => a.Name.Contains("lounge", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("door-open", StringComparison.OrdinalIgnoreCase) ?? false)) return false;
        if (qAmenities.PriorityBoarding == true && !o.Amenities.Any(a => a.Name.Contains("priority", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("rocket", StringComparison.OrdinalIgnoreCase) ?? false)) return false; *@
        if (qAmenities.CheckedBag == true && !o.Amenities.Any(a => a.Type == AmenityType.BAGGAGE)) return false;
        @* if (qAmenities.Alcohol == true && !o.Amenities.Any(a => a.Name.Contains("alcohol", StringComparison.OrdinalIgnoreCase) || a.IconClass?.Contains("cup-straw", StringComparison.OrdinalIgnoreCase) ?? false)) return false; *@

        return true;
    }

    static string DepartBucket(DateTime dt)
    {
        int mins = dt.Hour * 60 + dt.Minute;
        if (mins < 300) return "overnight";
        if (mins < 720) return "morning";
        if (mins < 1080) return "afternoon";
        return "evening";
    }

    void ResetFilters()
    {
        qText = "";
        qCabin = "";
        qNonstopOnly = false;
        qAtMostOneStop = false;
        qMinPrice = null;
        qMaxPrice = null;
        qDepartBucket = "";
        qAmenities = new AmenityQuery();
    }

    void Toggle(FlightViewOption o)
    {
        bool willOpen = !o.IsOpen;
        foreach (FlightViewOption x in (Result?.Options ?? Enumerable.Empty<FlightViewOption>())) x.IsOpen = false;
        o.IsOpen = willOpen;
    }

    void Select(FlightViewOption o)
    {
        // Toggle selection using string Id
        string? optionId = o.Id;
        if (string.IsNullOrWhiteSpace(optionId)) return;

        if (Selected.Contains(optionId)) Selected.Remove(optionId);
        else Selected.Add(optionId);

        // Hide compare if fewer than 2 selected
        if (Selected.Count < 2)
        {
            ShowCompareJson = false;
        }
    }

    void ShowCompare()
    {
        var payload = (Result?.Options ?? Enumerable.Empty<FlightViewOption>()).Where(x => Selected.Contains(x.Id))
            .Select(x => new {
                x.Id,
                Cabin = string.Join("/", x.Cabins ?? new List<string>()) ,
                x.Price,
                x.Currency,
                x.Stops,
                x.Origin,
                x.Destination,
                Legs = x.Legs.Select(l => new { l.Carrier.Code, l.FlightNumber, l.Origin, l.Destination, Depart = l.Depart.ToString(format: "O"), Arrive = l.Arrive.ToString(format: "O") })
            });
        SelectedJson = System.Text.Json.JsonSerializer.Serialize(payload, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        ShowCompareJson = true;
    }

    void BackToSearch() => Nav.NavigateTo("/platform/pnr/create");

    // ===== Lifecycle =====
    protected override void OnInitialized()
    {
        _client = HttpClientFactory.CreateClient(name: "AvaApi");
    }

    protected override async Task OnParametersSetAsync()
    {
        // Route param wins, else fall back to ?tq=
        string? id = !string.IsNullOrWhiteSpace(TravelQuoteId) ? TravelQuoteId : tq;

        if (string.IsNullOrWhiteSpace(id))
        {
            _error = "Missing TravelQuoteId";
            Nav.NavigateTo("/platform/pnr/create", forceLoad: true);
            return;
        }

        _pageIsLoading = true;
        _error = null;

        _cts?.Cancel();
        _cts?.Dispose();
        _cts = new CancellationTokenSource();
        CancellationToken ct = _cts.Token;

        // Build URL
        string? url  = $"api/v1/travel/quotes/ui/getflightresults/{Uri.EscapeDataString(id ?? string.Empty)}";

        await _log.InformationAsync(
            evt: "BOOKING_REQ_RESULTS_FETCH_START",
            cat: SysLogCatType.Api,
            act: SysLogActionType.Start,
            message: "Fetching flight results for quote ID",
            ent: nameof(FlightViewOption),
            entId: url,
            note: "ingress:client");

        try
        {
            FlightSearchResponse? result = await _client.GetFromJsonAsync<FlightSearchResponse?>(url, ct);

            if (result == null)
            {
                _error = "Flight results data is null";
                await _log.WarningAsync(
                    evt: "BOOKING_REQ_RESULTS_EMPTY",
                    cat: SysLogCatType.Api,
                    act: SysLogActionType.Read,
                    message: _error,
                    ent: nameof(FlightViewOption),
                    entId: url);
                Nav.NavigateTo(uri: "/platform/pnr/create", forceLoad: true);  //TODO: better error handling (page? -> error page with message?)
                return;
            }
            
            _error = null;

            Result = result;

            await _log.InformationAsync(
                evt: "BOOKING_REQ_RESULTS_FETCH_OK",
                cat: SysLogCatType.Api,
                act: SysLogActionType.End,
                message: "Flight results fetched",
                ent: nameof(FlightViewOption),
                entId: url,
                note: $"count={Result.Options?.Count ?? 0}");
        }
        catch (HttpRequestException ex)
        {
            _error = $"Network error: {ex.Message}";
            await _log.ErrorAsync(
                evt: "BOOKING_REQ_RESULTS_HTTP_ERR",
                cat: SysLogCatType.Api,
                act: SysLogActionType.Read,
                message: "HTTP error while fetching flight results",
                ex: ex,
                ent: nameof(FlightViewOption),
                entId: url,
                note: "http_error");
                
            Nav.NavigateTo(uri: "/platform/pnr/create", forceLoad: true);  //TODO: better error handling (page? -> error page with message?)
        }
        catch (TaskCanceledException)
        {
            await _log.WarningAsync(
                evt: "BOOKING_REQ_RESULTS_CANCELED",
                cat: SysLogCatType.Api,
                act: SysLogActionType.Cancel,
                message: "Flight results fetch cancelled",
                ent: nameof(FlightViewOption),
                entId: url,
                note: "task_canceled");

            // Ignore cancellations
            Nav.NavigateTo(uri: "/platform/pnr/create", forceLoad: true);  //TODO: better error handling (page? -> error page with message?)
        }
        catch (Exception ex)
        {
            _error = $"Unexpected error: {ex.Message}";
            await _log.ErrorAsync(
                evt: "BOOKING_REQ_RESULTS_UNEXPECTED",
                cat: SysLogCatType.Api,
                act: SysLogActionType.Create,
                message: ex.ToString(),
                ex: ex,
                ent: nameof(FlightViewOption),
                entId: url,
                note: "unexpected");
        }
        finally
        {
            _pageIsLoading = false;
            StateHasChanged();
        }
    }
}
